<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lil House</title>

    <!-- jQuery files-->
    <script src="js/JQuery/jquery-3.5.1.js"></script>
    <script src="js/Bootstrap/bootstrap.min.js"></script>

    <!-- Css files-->
    <link rel="stylesheet" href="css/Boostrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/commonStyling.css" />

    <!-- Firebase Reference-->
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-storage.js"></script>

    <script src="firebase-key.js"></script>

    <!--Vue file-->
    <script src="js/Vue/vue.js"></script>

    <!--Google Icons-->
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,500,700,400italic|Material+Icons">


    <style>
        @media screen and (min-width: 1200px) {
            .input-group {
                width: 400px;
            }
            .imgs{
                max-width: 500px;
            }
        }

        @media screen and (min-width: 600px) and (max-width: 1200px) {
            .input-group {
                width: 300px;
            }
            .imgs{
                max-width: 300px;
            }
        }
        @media screen and (max-width: 600px) {
            .imgs{
                max-width: 220px;
            }
        }
        @media screen and (max-width: 375px) {
            .imgs{
                max-width: 178px;
            }
        }

        .flexContainer {
            width: 100%;
            height: auto;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: flex-start;
            align-content: flex-start;
        }

        #container {
            margin: 2%;
        }

        #previewSection {
            background-color: #ebebeb;
            border-top: 0.4px solid black;
            border-bottom: 0.4px solid black;
            padding-bottom: 20px;
        }

        .previewDivs {
            position: relative;
            animation-name: MoveUpDown;
            animation-duration: 4s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        .previewDelete {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .previewDelete:hover {
            background-color: gray;
        }

        .imgs {
            height: auto;
        }

        .spinnerContainer {
            height: 100%;
            width: 100%;
            background-color: rgb(122, 122, 122, 0.6);
            z-index: 3;
            top: 0;
            left: 0;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0;
            animation: Spinner 1.2s linear infinite;
        }

        .spinner:after {
            content: " ";
            display: block;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            margin: 8px;
            border: 6px solid #fff;
            border-color: #fff transparent #fff transparent;
        }

        .errorMsg {
            color: #db0000;
        }


        @keyframes MoveUpDown {
            0%,
            100% {
                top: 0px;
            }

            50% {
                top: 20px;
            }
        }

        @keyframes Spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        var previewImgs = [];
        var errorText;
        var galleryImgs = [];
        var storageRef = storage.ref();
        var galleryCollection = firestore.collection("gallery");

        $(document).ready(function () {
            $("#navbar-holder").load("navigationbar.html");

            $("#imageUpload").change(function () {
                preview.SetPreviews();
            })

            $("#btnUpload").click(function () {
                preview.UploadToFirebase();
            })
        });

    </script>
</head>

<!-- check the Comments for more info -->

<body>
    <div id="navbar-holder"></div>

    <div id="container">

        <div class="input-group">
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="imageUpload" aria-describedby="inputGroupFileAddon01"
                    accept="image/*" multiple>
                <label class="custom-file-label" for="imageUpload">Choose File</label>
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-success" id="btnUpload" type="submit">Upload</button>
            </div>
        </div>

        <br />

        <section id="previewSection" class="flexContainer previewVue" v-if="previewImgs.length">
            <div v-for="previewImg in previewImgs" :key="previewImg.imgUrl" class="previewDivs"
                v-bind:id="previewImg.id">
                <img class="previewDelete" src="icons/delete.png" @click="RemovePreview($event)">
                <img v-bind:src="previewImg.imgUrl" v-bind:title="previewImg.name" class="img-thumbnail imgs">
                <div v-if="previewImg.imgUploading" class="spinnerContainer">
                    <div v-if="!previewImg.uploadError" class="spinner"></div>
                    <p v-if="!previewImg.uploadError">{{previewImg.uploadProgress}}%</p>
                    <p v-if="previewImg.uploadError" class="errorMsg">Error Uploading</p>
                </div>

            </div>
        </section>

        <br />


        <section id="gallerySection" class="flexContainer">
            <div v-for="galleryImg in galleryImgs" :key="galleryImg.id" v-bind:id="galleryImg.id">
                <img v-bind:src="galleryImg.imgUrl" class="img-thumbnail imgs">
            </div>
        </section>

    </div>

    <!-- Vue JS -->
    <script>

        var errorImgs = [];
        var preview = new Vue({
            el: "#previewSection",
            data: {
                previewImgs: previewImgs,
                errorText: errorText,
                errorImgs: errorImgs
            },
            methods: {
                SetPreviews: function () {
                    var files = document.getElementById("imageUpload").files;
                    this.previewImgs = [];
                    let counter = 0;
                    for (let file of files) {
                        this.previewImgs.push({
                            id: counter,
                            imgUrl: URL.createObjectURL(file),
                            imgName: file.name,
                            imgUploading: false,
                            uploadError: false,
                            uploadProgress: 0
                        })
                        counter++;
                    }
                },
                RemovePreview: function (e) {
                    //as index of img is set as the parent div's id, get the index number
                    let idToRemove = e.target.parentElement.id;
                    let urlToRemove = e.target.parentElement.querySelector(".imgs").src;

                    //remove the file from files
                    this.DeleteSelectedPreview(idToRemove, urlToRemove);
                },
                DeleteSelectedPreview: function (imgId, imgUrl) {
                    //remove 1 item at that index and remove the image URL from memory
                    console.log(`id: ${imgId}`);
                    URL.revokeObjectURL(imgUrl)

                    var index = this.previewImgs.map(img => {
                        return img.id;
                    }).indexOf(Number(imgId));

                    if (index != -1)
                        this.previewImgs.splice(index, 1);
                },
                UploadToFirebase: async function () {

                    let uploadPromise = this.previewImgs.map(async (img) => {

                        var galleryAlbum = "Family";

                        img.uploadError = false;
                        img.imgUploading = true;

                        let imgPath = "images/" + galleryAlbum + "/" + img.imgName;
                        let imagesRef = storageRef.child(imgPath)
                        let blob = await fetch(img.imgUrl).then(r => r.blob())

                        //upload the image itself to cloud storage
                        var uploadTask = imagesRef.put(blob);

                        // .then(async function (snapshot) {
                        //     //upload the image path to firestore
                        //     await galleryCollection.doc(galleryAlbum).collection("Images").doc().set({
                        //         imgPath: imgPath
                        //     }).then(() => {
                        //         preview.DeleteSelectedPreview(img.id,img.imgUrl);
                        //     })
                        // }).catch(()=>img.uploadError=true)


                        uploadTask.on('state_changed', function (snapshot) {
                            img.uploadProgress = parseInt((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            
                            //set upload progress to 99, leave 1% to upload into firestore
                            img.uploadProgress = img.uploadProgress == 100 ? 99:img.uploadProgress;

                        }, function (error) {
                            // Handle unsuccessful uploads
                            img.uploadError = true;
                        }, async function () {
                            // Handle successful uploads on complete
                            //upload the image path to firestore
                            await galleryCollection.doc(galleryAlbum).collection("Images").doc().set({
                                imgPath: imgPath
                            }).then(() => {
                                //set progress to 100 when done.
                                img.uploadProgress=100;
                                preview.DeleteSelectedPreview(img.id, img.imgUrl);
                            })
                        });
                    })
                }
            }
        });


        var gallery = new Vue({
            el: "#gallerySection",
            data: {
                galleryImgs: galleryImgs
            },
            methods: {
                ReadRealTimeGallery: function () {

                    galleryCollection.onSnapshot(snapshot => {

                        snapshot.docs.map(doc => {
                            var imagePath = doc.data().imgPath;
                            console.log(doc.data().imgPath)

                            storageRef.child(imagePath).getDownloadURL().then(function (url) {
                                // This can be downloaded directly:
                                var xhr = new XMLHttpRequest();
                                xhr.responseType = 'blob';
                                xhr.onload = function (event) {
                                    var blob = xhr.response;
                                };
                                xhr.open('GET', url);
                                xhr.send();

                                this.galleryImgs.push({
                                    id: doc.id,
                                    imgUrl: url
                                });
                            })
                        })
                    });
                },
                GetAllGalleryAlbums: function () {
                    galleryCollection.onSnapshot(snapshot => {
                        snapshot.docs.map(doc => {
                            console.log("updated");
                        })
                    })
                }
            },
            beforeMount() {
                this.GetAllGalleryAlbums()
            }

        })

    </script>


</body>

</html>